import { describe, expect, it } from '@jest/globals';
import path from 'path';
import { State } from '../dacc/state';
describe('dacc integration tests', () => {
    const alpineVersion = '3.20';
    const baseImage = `busybox:uclibc`;
    const alpineBase = `alpine:${alpineVersion}`;
    const golangBase = `golang:1.23-alpine${alpineVersion}`;
    it('image build', async () => {
        const base = await new State().from(baseImage);
        await base.image.build({ tag: ['dacc22'] });
    });
    it('image run', async () => {
        const base = await new State().from(baseImage);
        await base.image.run({ run: { command: 'echo', args: ['Hello, World!'] } });
    });
    it('run', async () => {
        const base = await new State().from(baseImage);
        const { stdout } = await base
            .run('echo Hello, World! >> /hello.txt')
            .image.run({ run: { command: 'cat', args: ['/hello.txt'] } });
        expect(stdout).toContain('Hello, World!');
    });
    it('run multiple commands', async () => {
        const base = await new State().from(baseImage);
        const { stdout } = await base
            .run('echo Hello, World! >> /hello.txt')
            .run('echo Goodbye, World! >> /hello.txt')
            .image.run({ run: { command: 'cat', args: ['/hello.txt'] } });
        expect(stdout).toContain('Hello, World!');
        expect(stdout).toContain('Goodbye, World!');
    });
    it('workdir from image config', async () => {
        const base = await new State().from(baseImage);
        const { stdout } = await base.workdir('/app').image.run({ run: { command: 'pwd' } });
        expect(stdout).toBe('/app\n');
    });
    it('env from image config', async () => {
        const base = await new State().from(golangBase);
        const { stdout } = await base.image.run({ run: { command: 'env' } });
        expect(stdout).toContain('GOLANG_VERSION');
    });
    it('workdir', async () => {
        const base = await new State().from(baseImage);
        const { stdout } = await base.workdir('/app').image.run({ run: { command: 'ls', args: ['/'] } });
        expect(stdout).toContain('app\n');
    });
    it('copy', async () => {
        const base = await new State().from(baseImage);
        const testFile = 'a.txt';
        const { stdout } = await base.copy(testFile, '/')
            .image.run({
            build: { contextPath: path.join(__dirname, 'testfiles') },
            run: { command: 'ls', args: ['/'] }
        });
        expect(stdout).toContain(testFile);
    });
    it('copy multiple files', async () => {
        // TODO: test with test files
        const files = ["a.txt", "b.txt"];
        const base = await new State().from(baseImage);
        const { stdout } = await base.copy(files, '/')
            .image.run({
            build: { contextPath: path.join(__dirname, 'testfiles') },
            run: { command: 'ls', args: files }
        });
        expect(stdout).toContain(files.join('\n'));
    });
    it('copy directory', async () => {
        const files = ["a.txt", "b.txt"];
        const base = await new State().from(baseImage);
        const { stdout } = await base.copy('.', '/tests')
            .image.run({
            build: { contextPath: path.join(__dirname, 'testfiles') },
            run: { command: 'ls', args: ['/tests'] }
        });
        expect(stdout).toContain(files.join('\n'));
    });
    it('copy directory with glob', async () => {
        const files = ["a.txt", "b.txt"];
        const base = await new State().from(baseImage);
        const { stdout } = await base.copy('*.txt', '/tests')
            .image.run({
            build: { contextPath: path.join(__dirname, 'testfiles') },
            run: { command: 'ls', args: ['/tests'] }
        });
        expect(stdout).toContain(files.join('\n'));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN0YXRlLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXRDLFFBQVEsQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUU7SUFDcEMsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDO0lBQzdCLE1BQU0sU0FBUyxHQUFHLGdCQUFnQixDQUFDO0lBQ25DLE1BQU0sVUFBVSxHQUFHLFVBQVUsYUFBYSxFQUFFLENBQUM7SUFDN0MsTUFBTSxVQUFVLEdBQUcscUJBQXFCLGFBQWEsRUFBRSxDQUFDO0lBRXhELEVBQUUsQ0FBQyxhQUFhLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFDekIsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFJLEtBQUssRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUM5QyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2hELENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLFdBQVcsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN2QixNQUFNLElBQUksR0FBRyxNQUFNLElBQUksS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQzlDLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLGVBQWUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2hGLENBQUMsQ0FBQyxDQUFDO0lB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QU8sRUFBRSxRQUFRLENBQUM7YUFDaEQsS0FBSyxDQUFDLEdBQUcsQ0FFTjtZQUNJLEtBQUssRUFBRSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsRUFBRTtZQUV6RCxHQUFHLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFO1NBQzNDLENBQUMsQ0FBQztRQUNYLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQy9DLENBQUMsQ0FBQyxDQUFBO0FBQ04sQ0FBQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkZXNjcmliZSwgZXhwZWN0LCBpdCB9IGZyb20gJ0BqZXN0L2dsb2JhbHMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBTdGF0ZSB9IGZyb20gJy4uL2RhY2Mvc3RhdGUnO1xuXG5kZXNjcmliZSgnZGFjYyBpbnRlZ3JhdGlvbiB0ZXN0cycsICgpID0+IHtcbiAgICBjb25zdCBhbHBpbmVWZXJzaW9uID0gJzMuMjAnO1xuICAgIGNvbnN0IGJhc2VJbWFnZSA9IGBidXN5Ym94OnVjbGliY2A7XG4gICAgY29uc3QgYWxwaW5lQmFzZSA9IGBhbHBpbmU6JHthbHBpbmVWZXJzaW9ufWA7XG4gICAgY29uc3QgZ29sYW5nQmFzZSA9IGBnb2xhbmc6MS4yMy1hbHBpbmUke2FscGluZVZlcnNpb259YDtcblxuICAgIGl0KCdpbWFnZSBidWlsZCcsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgYmFzZSA9IGF3YWl0IG5ldyBTdGF0ZSgpLmZyb20oYmFzZUltYWdlKVxuICAgICAgICBhd2FpdCBiYXNlLmltYWdlLmJ1aWxkKHsgdGFnOiBbJ2RhY2MyMiddIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2ltYWdlIHJ1bicsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgYmFzZSA9IGF3YWl0IG5ldyBTdGF0ZSgpLmZyb20oYmFzZUltYWdlKVxuICAgICAgICBhd2FpdCBiYXNlLmltYWdlLnJ1bih7IHJ1bjogeyBjb21tYW5kOiAnZWNobycsIGFyZ3M6IFsnSGVsbG8sIFdvcmxkISddIH0gfSk7XG4gICAgfSk7XG5cbiAgICBpdCgncnVuJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBiYXNlID0gYXdhaXQgbmV3IFN0YXRlKCkuZnJvbShiYXNlSW1hZ2UpXG4gICAgICAgIGNvbnN0IHsgc3Rkb3V0IH0gPSBhd2FpdCBiYXNlXG4gICAgICAgICAgICAucnVuKCdlY2hvIEhlbGxvLCBXb3JsZCEgPj4gL2hlbGxvLnR4dCcpXG4gICAgICAgICAgICAuaW1hZ2UucnVuKHsgcnVuOiB7IGNvbW1hbmQ6ICdjYXQnLCBhcmdzOiBbJy9oZWxsby50eHQnXSB9IH0pO1xuICAgICAgICBleHBlY3Qoc3Rkb3V0KS50b0NvbnRhaW4oJ0hlbGxvLCBXb3JsZCEnKTtcbiAgICB9KVxuXG4gICAgaXQoJ3J1biBtdWx0aXBsZSBjb21tYW5kcycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgYmFzZSA9IGF3YWl0IG5ldyBTdGF0ZSgpLmZyb20oYmFzZUltYWdlKVxuICAgICAgICBjb25zdCB7IHN0ZG91dCB9ID0gYXdhaXQgYmFzZVxuICAgICAgICAgICAgLnJ1bignZWNobyBIZWxsbywgV29ybGQhID4+IC9oZWxsby50eHQnKVxuICAgICAgICAgICAgLnJ1bignZWNobyBHb29kYnllLCBXb3JsZCEgPj4gL2hlbGxvLnR4dCcpXG4gICAgICAgICAgICAuaW1hZ2UucnVuKHsgcnVuOiB7IGNvbW1hbmQ6ICdjYXQnLCBhcmdzOiBbJy9oZWxsby50eHQnXSB9IH0pO1xuICAgICAgICBleHBlY3Qoc3Rkb3V0KS50b0NvbnRhaW4oJ0hlbGxvLCBXb3JsZCEnKTtcbiAgICAgICAgZXhwZWN0KHN0ZG91dCkudG9Db250YWluKCdHb29kYnllLCBXb3JsZCEnKTtcbiAgICB9KVxuXG5cbiAgICBpdCgnd29ya2RpciBmcm9tIGltYWdlIGNvbmZpZycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgYmFzZSA9IGF3YWl0IG5ldyBTdGF0ZSgpLmZyb20oYmFzZUltYWdlKVxuICAgICAgICBjb25zdCB7IHN0ZG91dCB9ID0gYXdhaXQgYmFzZS53b3JrZGlyKCcvYXBwJykuaW1hZ2UucnVuKHsgcnVuOiB7IGNvbW1hbmQ6ICdwd2QnIH0gfSk7XG4gICAgICAgIGV4cGVjdChzdGRvdXQpLnRvQmUoJy9hcHBcXG4nKTtcbiAgICB9KVxuXG4gICAgaXQoJ2VudiBmcm9tIGltYWdlIGNvbmZpZycsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgYmFzZSA9IGF3YWl0IG5ldyBTdGF0ZSgpLmZyb20oZ29sYW5nQmFzZSlcbiAgICAgICAgY29uc3QgeyBzdGRvdXQgfSA9IGF3YWl0IGJhc2UuaW1hZ2UucnVuKHsgcnVuOiB7IGNvbW1hbmQ6ICdlbnYnIH0gfSk7XG4gICAgICAgIGV4cGVjdChzdGRvdXQpLnRvQ29udGFpbignR09MQU5HX1ZFUlNJT04nKTtcbiAgICB9KVxuXG4gICAgaXQoJ3dvcmtkaXInLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGJhc2UgPSBhd2FpdCBuZXcgU3RhdGUoKS5mcm9tKGJhc2VJbWFnZSlcbiAgICAgICAgY29uc3QgeyBzdGRvdXQgfSA9IGF3YWl0IGJhc2Uud29ya2RpcignL2FwcCcpLmltYWdlLnJ1bih7IHJ1bjogeyBjb21tYW5kOiAnbHMnLCBhcmdzOiBbJy8nXSB9IH0pO1xuICAgICAgICBleHBlY3Qoc3Rkb3V0KS50b0NvbnRhaW4oJ2FwcFxcbicpO1xuICAgIH0pXG5cbiAgICBpdCgnY29weScsIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgYmFzZSA9IGF3YWl0IG5ldyBTdGF0ZSgpLmZyb20oYmFzZUltYWdlKVxuICAgICAgICBjb25zdCB0ZXN0RmlsZSA9ICdhLnR4dCdcbiAgICAgICAgY29uc3QgeyBzdGRvdXQgfSA9IGF3YWl0IGJhc2UuY29weSh0ZXN0RmlsZSwgJy8nKVxuICAgICAgICAgICAgLmltYWdlLnJ1bihcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkOiB7IGNvbnRleHRQYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdGZpbGVzJykgfSxcbiAgICAgICAgICAgICAgICAgICAgcnVuOiB7IGNvbW1hbmQ6ICdscycsIGFyZ3M6IFsnLyddIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgZXhwZWN0KHN0ZG91dCkudG9Db250YWluKHRlc3RGaWxlKTtcbiAgICB9KTtcblxuICAgIGl0KCdjb3B5IG11bHRpcGxlIGZpbGVzJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAvLyBUT0RPOiB0ZXN0IHdpdGggdGVzdCBmaWxlc1xuICAgICAgICBjb25zdCBmaWxlcyA9IFtcImEudHh0XCIsIFwiYi50eHRcIl1cbiAgICAgICAgY29uc3QgYmFzZSA9IGF3YWl0IG5ldyBTdGF0ZSgpLmZyb20oYmFzZUltYWdlKVxuICAgICAgICBjb25zdCB7IHN0ZG91dCB9ID0gYXdhaXQgYmFzZS5jb3B5KGZpbGVzLCAnLycpXG4gICAgICAgICAgICAuaW1hZ2UucnVuKHtcbiAgICAgICAgICAgICAgICBidWlsZDogeyBjb250ZXh0UGF0aDogcGF0aC5qb2luKF9fZGlybmFtZSwgJ3Rlc3RmaWxlcycpIH0sXG4gICAgICAgICAgICAgICAgcnVuOiB7IGNvbW1hbmQ6ICdscycsIGFyZ3M6IGZpbGVzIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICBleHBlY3Qoc3Rkb3V0KS50b0NvbnRhaW4oZmlsZXMuam9pbignXFxuJykpO1xuICAgIH0pXG5cbiAgICBpdCgnY29weSBkaXJlY3RvcnknLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVzID0gW1wiYS50eHRcIiwgXCJiLnR4dFwiXVxuICAgICAgICBjb25zdCBiYXNlID0gYXdhaXQgbmV3IFN0YXRlKCkuZnJvbShiYXNlSW1hZ2UpXG4gICAgICAgIGNvbnN0IHsgc3Rkb3V0IH0gPSBhd2FpdCBiYXNlLmNvcHkoJy4nLCAnL3Rlc3RzJylcbiAgICAgICAgICAgIC5pbWFnZS5ydW4oXG5cbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGJ1aWxkOiB7IGNvbnRleHRQYXRoOiBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdGZpbGVzJykgfSxcblxuICAgICAgICAgICAgICAgICAgICBydW46IHsgY29tbWFuZDogJ2xzJywgYXJnczogWycvdGVzdHMnXSB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIGV4cGVjdChzdGRvdXQpLnRvQ29udGFpbihmaWxlcy5qb2luKCdcXG4nKSk7XG4gICAgfSlcblxuICAgIGl0KCdjb3B5IGRpcmVjdG9yeSB3aXRoIGdsb2InLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVzID0gW1wiYS50eHRcIiwgXCJiLnR4dFwiXVxuICAgICAgICBjb25zdCBiYXNlID0gYXdhaXQgbmV3IFN0YXRlKCkuZnJvbShiYXNlSW1hZ2UpXG4gICAgICAgIGNvbnN0IHsgc3Rkb3V0IH0gPSBhd2FpdCBiYXNlLmNvcHkoJyoudHh0JywgJy90ZXN0cycpXG4gICAgICAgICAgICAuaW1hZ2UucnVuKFxuXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBidWlsZDogeyBjb250ZXh0UGF0aDogcGF0aC5qb2luKF9fZGlybmFtZSwgJ3Rlc3RmaWxlcycpIH0sXG5cbiAgICAgICAgICAgICAgICAgICAgcnVuOiB7IGNvbW1hbmQ6ICdscycsIGFyZ3M6IFsnL3Rlc3RzJ10gfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBleHBlY3Qoc3Rkb3V0KS50b0NvbnRhaW4oZmlsZXMuam9pbignXFxuJykpO1xuICAgIH0pXG59KSJdfQ==